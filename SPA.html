<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WardrobeOracle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .app-container {
            max-width: 420px;
            height: 90vh;
            max-height: 800px;
        }
        /* Simple transition for view switching */
        .view {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .view.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }
        .outfit-card {
            transition: transform 0.3s ease-in-out;
        }
        .outfit-card:hover {
            transform: translateY(-5px);
        }
        #auto-category-btn.loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <div id="app" class="app-container bg-white rounded-3xl shadow-2xl flex flex-col overflow-hidden border-4 border-gray-200">

        <!-- Header -->
        <header class="flex items-center justify-between p-4 border-b border-gray-200 bg-white z-10">
            <h1 class="text-xl font-bold text-gray-800">WardrobeOracle</h1>
            <div id="streak-counter" class="flex items-center gap-1 px-3 py-1 bg-orange-100 text-orange-600 rounded-full font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45.385c-.345.675-.5 1.425-.5 2.182V6.5a2.5 2.5 0 005 0V5.12c0-.757-.155-1.507-.5-2.182a1 1 0 00-1.45-.385c-.345.675-.5 1.425-.5 2.182V6.5a1.5 1.5 0 11-3 0V5.12c0-.757-.155-1.507-.5-2.182zM8 6.5a2.5 2.5 0 005 0V5.12c0-.757-.155-1.507-.5-2.182a1 1 0 00-1.45-.385c-.345.675-.5 1.425-.5 2.182V6.5a1.5 1.5 Schedar0 11-3 0V5.12c0-.757.155-1.507.5-2.182a1 1 0 001.45.385c.345-.675.5-1.425.5-2.182V3.5a2.5 2.5 0 00-5 0v1.62c0 .757.155 1.507.5 2.182a1 1 0 001.45.385c.345-.675.5-1.425.5-2.182V6.5z" clip-rule="evenodd" />
                    <path d="M9 10a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM6 10a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1zM4 11a1 1 0 100-2h-.01a1 1 0 100 2H4z" />
                </svg>
                <span id="streak-value">0</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 relative">
            <!-- Swipe to Style View -->
            <div id="swipe-view" class="view w-full h-full flex flex-col items-center justify-center">
                <div id="outfit-suggestion" class="w-full text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Today's Outfit</h2>
                    <p class="text-gray-500 mb-6">Here's a fresh look from your wardrobe.</p>
                    <div id="outfit-display" class="grid grid-cols-3 gap-2 md:gap-4 mb-6">
                        <!-- Outfit items will be injected here -->
                    </div>
                    <div id="outfit-actions" class="flex flex-col gap-3">
                        <button id="approve-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition-all transform hover:scale-105">
                            Love it! (Keep Streak)
                        </button>
                        <div class="flex gap-3">
                           <button id="swap-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-xl hover:bg-gray-50 transition-all">
                               Swap Item
                            </button>
                            <button id="skip-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-xl hover:bg-gray-50 transition-all">
                                New Outfit
                            </button>
                        </div>
                        <button id="get-style-tip-btn" class="w-full bg-purple-100 text-purple-700 font-semibold py-3 px-4 rounded-xl border border-purple-200 hover:bg-purple-200 transition-all flex items-center justify-center gap-2">
                            ‚ú® Get Style Tip
                        </button>
                        <div id="style-tip-container" class="mt-4 text-left p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[80px] hidden">
                            <p id="style-tip-content" class="text-sm text-gray-700"></p>
                        </div>
                    </div>
                </div>
                 <div id="outfit-chosen" class="hidden text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Outfit Set!</h2>
                    <p class="text-gray-500 mb-6">You're looking great. See you tomorrow for a new suggestion!</p>
                    <div id="chosen-outfit-display" class="grid grid-cols-3 gap-4 mb-6"></div>
                    <button id="get-chosen-style-tip-btn" class="w-full bg-purple-100 text-purple-700 font-semibold py-3 px-4 rounded-xl border border-purple-200 hover:bg-purple-200 transition-all flex items-center justify-center gap-2 mb-3">
                        ‚ú® Get Style Tip (Text-based)
                    </button>
                    <div id="chosen-style-tip-container" class="mt-2 text-left p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[80px] hidden">
                        <p id="chosen-style-tip-content" class="text-sm text-gray-700"></p>
                    </div>
                    <button id="get-photo-feedback-btn" class="w-full bg-blue-100 text-blue-700 font-semibold py-3 px-4 rounded-xl border border-blue-200 hover:bg-blue-200 transition-all flex items-center justify-center gap-2 mt-3">
                        üì∏ Get Feedback on Your Look
                    </button>
                    <input type="file" id="photo-upload-input" class="hidden" accept="image/*">
                    <div id="photo-feedback-container" class="mt-4 hidden">
                        <img id="user-photo-preview" src="#" alt="Your photo" class="rounded-lg max-h-64 mx-auto mb-4 border border-gray-200">
                        <div class="text-left p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[80px]">
                            <p id="photo-feedback-content" class="text-sm text-gray-700"></p>
                        </div>
                    </div>
                    <button id="get-wear-suggestions-btn" class="w-full bg-teal-100 text-teal-700 font-semibold py-3 px-4 rounded-xl border border-teal-200 hover:bg-teal-200 transition-all flex items-center justify-center gap-2 mt-3">
                        üìç Where to Wear in Barcelona?
                    </button>
                    <div id="wear-suggestions-container" class="mt-4 hidden text-left p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[80px]">
                        <div id="wear-suggestions-content" class="text-sm text-gray-700"></div>
                    </div>
                    <button id="reset-day-btn" class="mt-4 w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl hover:bg-gray-300 transition-all">Start a New Day</button>
                </div>
            </div>

            <!-- Wardrobe View -->
            <div id="wardrobe-view" class="view hidden w-full h-full flex flex-col">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">My Wardrobe</h2>
                    <button id="add-item-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all transform hover:scale-105 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add Item
                    </button>
                </div>
                <div id="wardrobe-grid" class="grid grid-cols-3 gap-4 mb-6">
                    <!-- Wardrobe items will be injected here -->
                </div>
                <div class="border-t pt-4 mt-auto">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Manage Categories</h3>
                    <div id="category-manager" class="space-y-2">
                         <ul id="category-list" class="flex flex-wrap gap-2">
                            <!-- Categories will be injected here -->
                         </ul>
                         <form id="add-category-form" class="flex gap-2">
                             <input type="text" id="new-category-name" placeholder="New category name" class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                             <button type="submit" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-700 transition-all">Add</button>
                         </form>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="grid grid-cols-2 gap-px bg-gray-200 border-t border-gray-200">
            <button data-view="swipe-view" class="nav-btn bg-white text-indigo-600 py-3 font-semibold flex flex-col items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg>
                Outfits
            </button>
            <button data-view="wardrobe-view" class="nav-btn bg-white text-gray-500 py-3 font-semibold flex flex-col items-center justify-center gap-1">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                Wardrobe
            </button>
        </nav>

        <!-- Add Item Modal -->
        <div id="add-item-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Add New Item</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="add-item-form" class="space-y-4">
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <div class="relative">
                           <input type="text" id="item-name" placeholder="e.g., Blue Denim Jacket" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                           <button type="button" id="auto-category-btn" title="Auto-categorize with AI" class="absolute inset-y-0 right-0 flex items-center pr-3 text-purple-600 hover:text-purple-800">
                                ‚ú®
                           </button>
                        </div>
                    </div>
                    <div>
                        <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="item-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label for="item-image-url" class="block text-sm font-medium text-gray-700">Image URL (Optional)</label>
                        <input type="text" id="item-image-url" placeholder="https://..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all">Add to Wardrobe</button>
                </form>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let wardrobe = [];
            let categories = ['Top', 'Bottom', 'Shoes', 'Outerwear', 'Accessory'];
            let currentOutfit = { top: null, bottom: null, shoes: null };
            let streak = 0;
            let dailyOutfitChosen = false;

            // --- DOM ELEMENTS ---
            const views = document.querySelectorAll('.view');
            const navButtons = document.querySelectorAll('.nav-btn');
            const wardrobeGrid = document.getElementById('wardrobe-grid');
            const addItemBtn = document.getElementById('add-item-btn');
            const addItemModal = document.getElementById('add-item-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addItemForm = document.getElementById('add-item-form');
            const outfitDisplay = document.getElementById('outfit-display');
            const chosenOutfitDisplay = document.getElementById('chosen-outfit-display');
            const streakValue = document.getElementById('streak-value');
            const getStyleTipBtn = document.getElementById('get-style-tip-btn');
            const styleTipContainer = document.getElementById('style-tip-container');
            const styleTipContent = document.getElementById('style-tip-content');
            const getChosenStyleTipBtn = document.getElementById('get-chosen-style-tip-btn');
            const chosenStyleTipContainer = document.getElementById('chosen-style-tip-container');
            const chosenStyleTipContent = document.getElementById('chosen-style-tip-content');
            const getPhotoFeedbackBtn = document.getElementById('get-photo-feedback-btn');
            const photoUploadInput = document.getElementById('photo-upload-input');
            const photoFeedbackContainer = document.getElementById('photo-feedback-container');
            const userPhotoPreview = document.getElementById('user-photo-preview');
            const photoFeedbackContent = document.getElementById('photo-feedback-content');
            const getWearSuggestionsBtn = document.getElementById('get-wear-suggestions-btn');
            const wearSuggestionsContainer = document.getElementById('wear-suggestions-container');
            const wearSuggestionsContent = document.getElementById('wear-suggestions-content');
            const autoCategoryBtn = document.getElementById('auto-category-btn');
            const categoryList = document.getElementById('category-list');
            const addCategoryForm = document.getElementById('add-category-form');

            // --- MOCK INITIAL DATA ---
            const initialWardrobe = [
                { id: 1, name: 'White T-Shirt', category: 'Top', imageUrl: 'https://placehold.co/300x400/FFFFFF/333333?text=T-Shirt' },
                { id: 2, name: 'Black Jeans', category: 'Bottom', imageUrl: 'https://placehold.co/300x400/333333/FFFFFF?text=Jeans' },
                { id: 3, name: 'White Sneakers', category: 'Shoes', imageUrl: 'https://placehold.co/300x400/FFFFFF/333333?text=Sneakers' },
                { id: 4, name: 'Blue Oxford Shirt', category: 'Top', imageUrl: 'https://placehold.co/300x400/60A5FA/FFFFFF?text=Shirt' },
                { id: 5, name: 'Khaki Chinos', category: 'Bottom', imageUrl: 'https://placehold.co/300x400/F5DEB3/333333?text=Chinos' },
                { id: 6, name: 'Brown Boots', category: 'Shoes', imageUrl: 'https://placehold.co/300x400/A52A2A/FFFFFF?text=Boots' },
                { id: 7, name: 'Denim Jacket', category: 'Outerwear', imageUrl: 'https://placehold.co/300x400/3B82F6/FFFFFF?text=Jacket' },
                { id: 8, name: 'Graphic Hoodie', category: 'Top', imageUrl: 'https://placehold.co/300x400/4B5563/FFFFFF?text=Hoodie' },
                { id: 9, name: 'Black Trousers', category: 'Bottom', imageUrl: 'https://placehold.co/300x400/1F2937/FFFFFF?text=Trousers'},
            ];
            
            // --- GEMINI API INTEGRATION ---

            /**
             * Calls the Gemini API with a given prompt.
             * Implements exponential backoff for retries.
             * @param {string} prompt The prompt to send to the API.
             * @param {string|null} base64ImageData Optional base64 encoded image data.
             * @returns {Promise<string>} The generated text from the API.
             */
            const callGeminiApi = async (prompt, base64ImageData = null) => {
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const parts = [{ text: prompt }];
                if (base64ImageData) {
                    parts.push({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: base64ImageData
                        }
                    });
                }

                const payload = {
                    contents: [{ parts: parts }],
                };

                let response;
                let retries = 3;
                let delay = 1000;

                for (let i = 0; i < retries; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const candidate = result.candidates?.[0];
                            if (candidate && candidate.content?.parts?.[0]?.text) {
                                return candidate.content.parts[0].text.trim();
                            }
                        }
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed:`, error);
                    }
                    
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }

                throw new Error("Failed to get a response from the Gemini API after several retries.");
            };


            /**
             * Generates and displays a style tip for the current outfit.
             * @param {HTMLElement} containerEl The container to show/hide.
             * @param {HTMLElement} contentEl The element to display the tip in.
             */
            const getStyleTip = async (containerEl, contentEl) => {
                if (!currentOutfit.top || !currentOutfit.bottom || !currentOutfit.shoes) {
                    contentEl.textContent = "Please make sure you have a complete outfit (top, bottom, shoes) to get a style tip.";
                    containerEl.classList.remove('hidden');
                    return;
                }

                // Show loading state
                containerEl.classList.remove('hidden');
                contentEl.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-700"></div><p class="ml-2">Getting style tip...</p></div>`;

                const outfitItems = [currentOutfit.top.name, currentOutfit.bottom.name, currentOutfit.shoes.name];
                const userPrompt = `You are a friendly and encouraging fashion stylist. You provide short, positive, and helpful style tips. Given the following outfit items: ${outfitItems.join(", ")}. 
                1. What is the overall vibe or style of this outfit? (e.g., casual, smart-casual, edgy).
                2. Suggest one type of occasion where this outfit would be perfect.
                3. Provide one simple accessory suggestion.
                Combine these points into a single, encouraging paragraph of 2-3 sentences.`;

                try {
                    const tip = await callGeminiApi(userPrompt);
                    contentEl.textContent = tip;
                } catch (error) {
                    console.error("Error getting style tip:", error);
                    contentEl.textContent = "Sorry, I couldn't get a style tip right now. Please try again later.";
                }
            };

            /**
             * Handles the photo upload, sends it to Gemini, and displays feedback.
             * @param {Event} e The file input change event.
             */
            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64String = event.target.result;
                    userPhotoPreview.src = base64String;
                    photoFeedbackContainer.classList.remove('hidden');
                    photoFeedbackContent.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-700"></div><p class="ml-2">Analyzing your photo...</p></div>`;

                    const prompt = "You are a positive and helpful fashion stylist. Analyze the outfit in this photo. Comment on the overall style, suggest an occasion it's good for, and give one constructive tip for a potential accessory or improvement. Keep it encouraging and under 50 words.";
                    
                    // Remove the data URL prefix for the API
                    const base64Data = base64String.split(',')[1];

                    try {
                        const feedback = await callGeminiApi(prompt, base64Data);
                        photoFeedbackContent.textContent = feedback;
                    } catch (error) {
                        console.error("Error getting photo feedback:", error);
                        photoFeedbackContent.textContent = "Sorry, I couldn't analyze your photo right now. Please try again.";
                    }
                };
                reader.readAsDataURL(file);
            };
            
            /**
             * Gets location-based suggestions for where to wear the outfit.
             */
            const getWearingSuggestions = async () => {
                 if (!currentOutfit.top || !currentOutfit.bottom || !currentOutfit.shoes) {
                    wearSuggestionsContent.textContent = "Please make sure you have a complete outfit to get suggestions.";
                    wearSuggestionsContainer.classList.remove('hidden');
                    return;
                }

                wearSuggestionsContainer.classList.remove('hidden');
                wearSuggestionsContent.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-teal-700"></div><p class="ml-2">Finding perfect spots in Barcelona...</p></div>`;
                
                const outfitItems = [currentOutfit.top.name, currentOutfit.bottom.name, currentOutfit.shoes.name];
                const date = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const prompt = `You are a local Barcelona style expert and city guide. The date is ${date}. A person in Barcelona is wearing this outfit: ${outfitItems.join(", ")}. Suggest three specific types of places or activities in Barcelona where this outfit would be perfect. Format the output as a numbered list with a brief, stylish description for each. For example: '1. El Born Cafe Hopping - Perfect for looking effortlessly chic while sipping a cortado.'`;

                try {
                    const suggestions = await callGeminiApi(prompt);
                    wearSuggestionsContent.innerHTML = suggestions.replace(/\n/g, '<br>');
                } catch (error) {
                    console.error("Error getting wearing suggestions:", error);
                    wearSuggestionsContent.textContent = "Sorry, I couldn't get any suggestions right now. Please try again later.";
                }
            };

            /**
             * Uses Gemini to suggest a category for a new item.
             */
            const getCategorySuggestion = async () => {
                const itemNameInput = document.getElementById('item-name');
                const itemName = itemNameInput.value;
                if (!itemName) {
                    alert("Please enter an item name first.");
                    return;
                }

                autoCategoryBtn.classList.add('loading');
                autoCategoryBtn.disabled = true;

                const categoryString = categories.join(', ');
                const prompt = `You are an expert fashion classifier. Given the item name "${itemName}" and the available categories: [${categoryString}], which is the single most appropriate category? Respond with only the category name from the list provided, and nothing else. Your response must be an exact match to one of the categories in the list.`;

                try {
                    const suggestedCategory = await callGeminiApi(prompt);
                    const categorySelect = document.getElementById('item-category');
                    
                    // Check if the suggested category exists in our list
                    const categoryExists = categories.some(cat => cat.toLowerCase() === suggestedCategory.toLowerCase());

                    if (categoryExists) {
                        categorySelect.value = categories.find(cat => cat.toLowerCase() === suggestedCategory.toLowerCase());
                    } else {
                        console.warn(`Gemini suggested a category "${suggestedCategory}" that doesn't exist.`);
                    }

                } catch (error) {
                    console.error("Error getting category suggestion:", error);
                    alert("Could not get a category suggestion at this time.");
                } finally {
                    autoCategoryBtn.classList.remove('loading');
                    autoCategoryBtn.disabled = false;
                }
            };


            // --- FUNCTIONS ---
            
            const renderCategoryManager = () => {
                categoryList.innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center bg-gray-200 text-gray-800 text-sm font-semibold px-3 py-1 rounded-full';
                    li.innerHTML = `
                        <span>${cat}</span>
                        <button data-category="${cat}" class="delete-category-btn ml-2 text-red-500 hover:text-red-700 font-bold">&times;</button>
                    `;
                    categoryList.appendChild(li);
                });
            };

            const populateCategoryDropdown = () => {
                const categorySelect = document.getElementById('item-category');
                categorySelect.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            };

            // Render wardrobe items in the grid
            const renderWardrobe = () => {
                wardrobeGrid.innerHTML = '';
                if (wardrobe.length === 0) {
                    wardrobeGrid.innerHTML = `<p class="col-span-3 text-center text-gray-500">Your wardrobe is empty. Add some items to get started!</p>`;
                    return;
                }
                wardrobe.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'relative group';
                    itemEl.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-auto object-cover rounded-lg aspect-[3/4]">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex items-end justify-center p-2">
                            <p class="text-white text-sm font-semibold text-center opacity-0 group-hover:opacity-100 transition-opacity">${item.name}</p>
                        </div>
                        <button data-id="${item.id}" class="delete-item-btn absolute top-1 right-1 h-6 w-6 bg-white bg-opacity-70 rounded-full flex items-center justify-center text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                    `;
                    wardrobeGrid.appendChild(itemEl);
                });
            };

            // Render the current outfit suggestion
            const renderOutfit = (displayContainer) => {
                displayContainer.innerHTML = '';
                const itemsToRender = [currentOutfit.top, currentOutfit.bottom, currentOutfit.shoes];
                itemsToRender.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'outfit-card bg-gray-50 p-2 rounded-lg shadow-sm border';
                    if (item) {
                       itemEl.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-auto object-cover rounded-md aspect-[3/4]">
                        <p class="text-xs text-center mt-1 font-medium text-gray-600">${item.name}</p>`;
                    } else {
                         itemEl.innerHTML = `<div class="w-full flex items-center justify-center text-gray-400 text-center text-xs font-semibold bg-gray-100 rounded-md aspect-[3/4]">Add items to this category!</div>`;
                    }
                    displayContainer.appendChild(itemEl);
                });
            };

            // Generate a random outfit
            const generateOutfit = () => {
                const tops = wardrobe.filter(i => i.category.toLowerCase() === 'top');
                const bottoms = wardrobe.filter(i => i.category.toLowerCase() === 'bottom');
                const shoes = wardrobe.filter(i => i.category.toLowerCase() === 'shoes');

                currentOutfit.top = tops.length > 0 ? tops[Math.floor(Math.random() * tops.length)] : null;
                currentOutfit.bottom = bottoms.length > 0 ? bottoms[Math.floor(Math.random() * bottoms.length)] : null;
                currentOutfit.shoes = shoes.length > 0 ? shoes[Math.floor(Math.random() * shoes.length)] : null;
                
                styleTipContainer.classList.add('hidden'); // Hide tip on new outfit
                renderOutfit(outfitDisplay);
            };

            // Switch between views
            const switchView = (viewId) => {
                views.forEach(view => {
                    view.classList.toggle('hidden', view.id !== viewId);
                });
                navButtons.forEach(btn => {
                    const isActive = btn.dataset.view === viewId;
                    btn.classList.toggle('text-indigo-600', isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                });
            };
            
            const updateStreak = (newStreak) => {
                streak = newStreak;
                streakValue.textContent = streak;
                const counter = document.getElementById('streak-counter');
                counter.classList.add('transform', 'scale-125');
                setTimeout(() => counter.classList.remove('transform', 'scale-125'), 150);
            };
            
            const handleApproveOutfit = () => {
                if(dailyOutfitChosen) return;
                updateStreak(streak + 1);
                dailyOutfitChosen = true;
                document.getElementById('outfit-suggestion').classList.add('hidden');
                document.getElementById('outfit-chosen').classList.remove('hidden');
                chosenStyleTipContainer.classList.add('hidden');
                photoFeedbackContainer.classList.add('hidden');
                wearSuggestionsContainer.classList.add('hidden');
                renderOutfit(chosenOutfitDisplay);
            };

            const resetDay = () => {
                dailyOutfitChosen = false;
                document.getElementById('outfit-suggestion').classList.remove('hidden');
                document.getElementById('outfit-chosen').classList.add('hidden');
                photoUploadInput.value = ''; // Reset file input
                generateOutfit();
            }

            // --- EVENT LISTENERS ---
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => switchView(btn.dataset.view));
            });

            addItemBtn.addEventListener('click', () => {
                populateCategoryDropdown();
                addItemModal.classList.remove('hidden');
            });
            closeModalBtn.addEventListener('click', () => addItemModal.classList.add('hidden'));

            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('item-name').value;
                const category = document.getElementById('item-category').value;
                let imageUrl = document.getElementById('item-image-url').value;

                if (!imageUrl) {
                    const bgColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    const textColor = '333333';
                    imageUrl = `https://placehold.co/300x400/${bgColor}/${textColor}?text=${encodeURIComponent(name.substring(0,15))}`;
                }

                const newItem = {
                    id: Date.now(),
                    name,
                    category,
                    imageUrl,
                };

                wardrobe.push(newItem);
                renderWardrobe();
                generateOutfit(); // Refresh outfit in case a new category was filled
                addItemModal.classList.add('hidden');
                addItemForm.reset();
            });

            wardrobeGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-item-btn')) {
                    const itemId = parseInt(e.target.dataset.id);
                    wardrobe = wardrobe.filter(item => item.id !== itemId);
                    renderWardrobe();
                    generateOutfit();
                }
            });
            
            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCategoryInput = document.getElementById('new-category-name');
                const newCategoryName = newCategoryInput.value.trim();
                if (newCategoryName && !categories.find(c => c.toLowerCase() === newCategoryName.toLowerCase())) {
                    categories.push(newCategoryName);
                    renderCategoryManager();
                }
                newCategoryInput.value = '';
            });

            categoryList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-category-btn')) {
                    const categoryToDelete = e.target.dataset.category;
                    categories = categories.filter(c => c !== categoryToDelete);
                    renderCategoryManager();
                }
            });
            
            document.getElementById('approve-btn').addEventListener('click', handleApproveOutfit);
            document.getElementById('skip-btn').addEventListener('click', generateOutfit);
            document.getElementById('reset-day-btn').addEventListener('click', resetDay);
            
            getStyleTipBtn.addEventListener('click', () => getStyleTip(styleTipContainer, styleTipContent));
            getChosenStyleTipBtn.addEventListener('click', () => getStyleTip(chosenStyleTipContainer, chosenStyleTipContent));
            
            getPhotoFeedbackBtn.addEventListener('click', () => photoUploadInput.click());
            photoUploadInput.addEventListener('change', handlePhotoUpload);
            
            getWearSuggestionsBtn.addEventListener('click', getWearingSuggestions);
            autoCategoryBtn.addEventListener('click', getCategorySuggestion);

            // A simple swap implementation: for now, it just gets a new outfit
            document.getElementById('swap-btn').addEventListener('click', generateOutfit);


            // --- INITIALIZATION ---
            const init = () => {
                wardrobe = [...initialWardrobe];
                renderWardrobe();
                renderCategoryManager();
                generateOutfit();
                updateStreak(0);
                switchView('swipe-view');
            };

            init();
        });
    </script>
</body>
</html>

